async function standardValidate(schema, input) {
    let result = schema['~standard'].validate(input);
    if (result instanceof Promise)
        result = await result;
    /**
     * If the `issues` field exists, the validation failed
     * @see https://github.com/standard-schema/standard-schema?tab=readme-ov-file#how-do-i-accept-standard-schemas-in-my-library
     */
    if (result.issues) {
        const errorDetails = JSON.stringify(result.issues, null, 2);
        throw new Error(`Config validation failed. Expectations were not matched:\n\n${errorDetails}`);
    }
    return result.value;
}
const defaultJsonParser = (config) => JSON.parse(Buffer.from(config).toString());
export const configHandler = async (request, { configParser, configSchema } = {}) => {
    const config = request.config;
    const parser = configParser || defaultJsonParser;
    let intermediateConfig;
    try {
        intermediateConfig = parser(config);
    }
    catch (error) {
        if (error instanceof Error) {
            throw new Error(`Failed to parse configuration: ${error.message}`);
        }
        else {
            throw new Error(`Failed to parse configuration: unknown error`);
        }
    }
    return configSchema
        ? standardValidate(configSchema, intermediateConfig)
        : intermediateConfig;
};
